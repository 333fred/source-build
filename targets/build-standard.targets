<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Condition="'$(ImportedRootDirProps)' == ''" Project="$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), dir.props))\dir.props" />

  <UsingTask AssemblyFile="$(BuildTaskDirectory)Microsoft.DotNet.SourceBuild.Tasks.dll" TaskName="WriteVersionsFile" />

  <!--
    =======================================================================================================
                                         Standard Targets
    =======================================================================================================
    
  -->

  <Target Name="_InitializeStandard">
    <FindInList CaseSensitive="false" List="@(Repository)" ItemSpecToFind="standard">
      <Output TaskParameter="ItemFound" ItemName="Standard" />
    </FindInList>

    <Error Condition="'%(Standard.ProjectDirectory)' == ''" Text="You are missing Standard metadata, or you need to specify a Standard build directory, either with the /p:PathToStandard switch, or in the 'targets/target.metadata'" />

    <PropertyGroup>
      <ProjectDirectory>%(Standard.ProjectDirectory)</ProjectDirectory>
      <StandardDirectory>%(Standard.ProjectDirectory)</StandardDirectory>
      <StandardPackageOutputDirectory>$(StandardDirectory)bin/packages/$(Configuration)/</StandardPackageOutputDirectory>
    </PropertyGroup>
  </Target>

  <Target Name="BuildStandard" DependsOnTargets="_InitializeStandard;BootstrapBuildTools">
    <Exec Command="$(StandardDirectory)build$(ShellExtension) -$(Configuration) -- /flp:v=diag"
          WorkingDirectory="$(StandardDirectory)" />

    <ItemGroup>
      <StandardPackages Include="$(StandardPackageOutputDirectory)*.nupkg" />
    </ItemGroup>

    <Copy SourceFiles="@(StandardPackages)"
          DestinationFolder="$(SourceBuiltPackagesPath)" />

    <WriteVersionsFile NugetPackages="@(StandardPackages)"
                       OutputPath="%(Standard.VersionFile)" />

    <Message Importance="Normal" Text="Wrote %(Standard.Identity) VersionsFile: %(Standard.VersionFile)" />
  </Target>

  <!-- no-op right now as dotnet/standard doesn't have clean.sh -->
  <Target Name="CleanStandard" />
</Project>
