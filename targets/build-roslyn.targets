<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask AssemblyFile="$(TaskDirectory)Microsoft.DotNet.SourceBuild.Tasks/bin/Debug/netstandard1.4/Microsoft.DotNet.SourceBuild.Tasks.dll" TaskName="AddSourceToNuGetConfig" />
  <UsingTask AssemblyFile="$(TaskDirectory)Microsoft.DotNet.SourceBuild.Tasks/bin/Debug/netstandard1.4/Microsoft.DotNet.SourceBuild.Tasks.dll" TaskName="GetHostRid" />
  <UsingTask AssemblyFile="$(TaskDirectory)Microsoft.DotNet.SourceBuild.Tasks/bin/Debug/netstandard1.4/Microsoft.DotNet.SourceBuild.Tasks.dll" TaskName="ChangeRuntimesSection" />
  <UsingTask AssemblyFile="$(TaskDirectory)Microsoft.DotNet.SourceBuild.Tasks/bin/Debug/netstandard1.4/Microsoft.DotNet.SourceBuild.Tasks.dll" TaskName="FixPathSeparator" />

  <PropertyGroup>
    <RoslynDirectory>$(SubmoduleDirectory)roslyn/</RoslynDirectory>
    <RoslynPackageOutputDirectory>$(RoslynDirectory)Binaries/Packages/</RoslynPackageOutputDirectory>
  </PropertyGroup>

  <!-- Roslyn Targets -->
  <Target Name="BuildRoslyn">
    <GetHostRid Condition="'$(TargetRid)' == ''">
      <Output PropertyName="TargetRid" TaskParameter="Rid" />
    </GetHostRid>

    <AddSourceToNuGetConfig NuGetConfigFile="$(RoslynDirectory)/NuGet.Config"
                            SourceName="Source-Build" 
                            SourcePath="$(SourceBuiltPackagesPath)" />

    <ItemGroup>
      <RoslynProjectJsonFiles Include="$(RoslynDirectory)/**/project.json" />
      <NuSpecFiles Include="$(RoslynDirectory)/**/*.nuspec" />
    </ItemGroup>

    <ChangeRuntimesSection ProjectJsonFiles="@(RoslynProjectJsonFiles)"
                           ReplacementRuntimeId="$(TargetRid)"
                           FilterRuntimeId="ubuntu.14.04-x64"
                           Condition="'$(OS)' != 'Windows_NT'" />

    <FixPathSeparator NuSpecFiles="@(NuSpecFiles)" />

    <PropertyGroup>
      <RoslynBuildCommand Condition="'$(OS)' != 'Windows_NT'">$(RoslynDirectory)cibuild.sh --$(Configuration) --SkipTests --SkipCrossGen --SkipCommitPrinting</RoslynBuildCommand>
      <RoslynBuildCommand Condition="'$(OS)' == 'Windows_NT'">$(RoslynDirectory)cibuild.cmd /$(Configuration)</RoslynBuildCommand>
      <RoslynBuildCommand Condition="'$(BuildTools_Dir)' != ''">$(RoslynBuildCommand) --bootstrap_cli_path $(BuildTools_Dir)/dotnetcli</RoslynBuildCommand>
      <RoslynBuildCommand Condition="'$(Cli_Path)' != ''">$(RoslynBuildCommand) --bootstrap_msbuild_cli_path $(Cli_Path)</RoslynBuildCommand>
    </PropertyGroup>
    <Exec Command="$(RoslynBuildCommand)"
          WorkingDirectory="$(RoslynDirectory)" />

    <Exec Command="$(RoslynDirectory)Binaries/$(Configuration)/Exes/CsiCore/corerun $(RoslynDirectory)Binaries/$(Configuration)/Exes/CsiCore/csi.exe src/NuGet/BuildNuGets.csx Binaries/$(Configuration) 42-localbuild $(RoslynPackageOutputDirectory)"
          WorkingDirectory="$(RoslynDirectory)" />

    <ItemGroup>
      <RoslynPackages Include="$(RoslynPackageOutputDirectory)*.nupkg" />
    </ItemGroup>

    <Copy SourceFiles="@(RoslynPackages)"
          DestinationFolder="$(SourceBuiltPackagesPath)" />

    <WriteVersionsFile NugetPackages="@(RoslynPackages)"
                       OutputPath="$(IntermediatePath)RoslynVersions.txt" />
  </Target>

  <Target Name="CleanRoslyn">
    <RemoveDir Directories="$(RoslynDirectory)Binaries" />
  </Target>
</Project>
